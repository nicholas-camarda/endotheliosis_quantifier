# Decisions Log

## Platform & Performance
- Must run on macOS Apple Silicon (M1) for inference and light workflows.
- Retain optional Windows (WSL2) + CUDA path (RTX 3080) for training; document when required.

## Framework
- **DECISION MADE 2025-08-21**: Migrate to fastai/PyTorch for all segmentation and training workflows.
- Leverage existing working fastai implementations from notebooks folder.
- Use PyTorch with MPS (Metal Performance Shaders) for Apple Silicon and CUDA for RTX 3080.
- This provides superior cross-platform support and leverages proven working code.

## Packaging & Structure
- Rename repository to `endotheliosis_quantifier`.
- Adopt `src/eq` package with CLI entrypoints for the 4 pipeline steps.
- Centralize configuration; remove hard-coded paths.

## Reproducibility & Standards
- Use Conda env `eq` exclusively for installs/execution.
- Follow `.agent-os/standards/code-style/python-style.md`.
- Separate test scripts for new/updated logic; assert specific outputs on test data.

## 2025-08-21: Repository Hygiene and Utilities Consolidation
**ID:** DEC-001
**Status:** Accepted
**Category:** technical

### Decision
- Consolidate `scripts/utils/` to a minimal, well-documented helper set; remove or merge redundant utilities.
- Do not track large/ephemeral folders: `notebooks/`, `earlier_models/`. Update `.gitignore` accordingly.

### Context
Improves maintainability, reduces confusion for users, and avoids committing bulky, non-source artifacts. Aligns with packaging goals and cross-platform reproducibility.

## 2025-01-27: CLI Pipeline System Implementation
**ID:** DEC-002
**Status:** Accepted
**Category:** technical

### Decision
- Implement comprehensive CLI pipeline system with `eq` command and subcommands for each pipeline step.
- Use `src/eq/__main__.py` as the main CLI entry point with argparse-based command parsing.
- Create wrapper functions in each module to handle CLI arguments and orchestrate pipeline steps.
- Install package in development mode with console script entry point.

### Commands Implemented
- `eq data-load` - Load and preprocess data with configurable paths
- `eq train-segmenter` - Train segmentation models with hyperparameter control
- `eq extract-features` - Extract features from images using trained models
- `eq quantify` - Run endotheliosis quantification pipeline
- `eq pipeline` - Execute complete end-to-end pipeline

### Context
Provides a centralized, user-friendly interface for running the endotheliosis quantification pipeline. Eliminates the need for users to understand internal module structure or manually orchestrate pipeline steps. Enables both step-by-step execution and full pipeline runs with consistent parameter handling.

## 2025-01-27: fastai/PyTorch Migration Decision
**ID:** DEC-003
**Status:** Accepted
**Category:** framework

### Decision
- Migrate from TensorFlow to fastai/PyTorch for all segmentation and training workflows.
- Convert existing working notebook implementations to production-ready Python modules.
- Implement dual-environment architecture with explicit mode selection between development (M1 Mac/MPS) and production (RTX 3080/CUDA).
- Use PyTorch's native MPS support for Apple Silicon and CUDA for NVIDIA GPUs.

### Rationale
- Existing fastai implementations in notebooks are proven and working
- PyTorch provides superior cross-platform support with native MPS and CUDA backends
- fastai offers higher-level API that works seamlessly across both backends
- Eliminates TensorFlow Metal compatibility issues
- Leverages existing developer expertise and working code

### Implementation Plan
1. Convert working notebook implementations to Python modules
2. Update environment dependencies from TensorFlow to fastai/PyTorch
3. Implement hardware detection and mode selection system
4. Migrate existing TensorFlow segmentation code to fastai/PyTorch
5. Update CLI pipeline to support dual-environment architecture

### Context
This decision addresses the dual-environment architecture requirements while leveraging existing working implementations. The fastai/PyTorch approach provides better cross-platform compatibility and eliminates the TensorFlow Metal issues that were previously encountered.
